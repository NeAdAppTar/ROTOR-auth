<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>ROTOR — Авторизация</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="stylesheet" href="style.css">

  <style>
    /* Полноэкранный фон */
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: url("pic1.jpg") no-repeat center center fixed;
      background-size: cover;
      font-family: "Segoe UI", sans-serif;
      color: white;
    }

    /* Карточка авторизации */
    .auth-card {
      background: rgba(0, 0, 0, 0.65);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      width: 340px;
    }

    .auth-card h1 {
      margin: 0 0 10px 0;
      font-size: 2em;
      letter-spacing: 1px;
    }

    .auth-card p {
      margin-bottom: 25px;
      color: #ccc;
    }

    /* Кнопка выхода (если нужно показывать после входа) */
    .logout-btn {
      margin-top: 15px;
      background: #ff5555;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
    }

    footer {
      font-size: 12px;
      color: #aaa;
      margin-top: 30px;
    }
  </style>
</head>

<body>
  <div class="auth-card">
    <h1>ROTOR</h1>
    <p>Вход через VK ID</p>

    <div id="vk_auth"></div>

    <footer>
      <p>ООО "Ротор", by NeAdAppTar, ShaUru1118</p>
    </footer>
  </div>

  <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>

  <script>
 function setUser(username) {
      document.cookie = `userLogin=${username}; path=/; max-age=3600`;
      localStorage.setItem('userLogin', username);

      const redirect = new URLSearchParams(window.location.search).get('redirect') || 'employee_dashboard.html';
      window.location.href = redirect;
    }

    async function findUserByVK(vkId) {
      try {
        const res = await fetch('https://rotor.pythonanywhere.com/users');
        if (!res.ok) throw new Error('Ошибка загрузки пользователей');
        const data = await res.json();

        const vkUrl = `https://vk.com/id${vkId}`;
        const found = Object.values(data).find(u => u.vk && u.vk.includes(vkUrl));

        return found ? found.login : null;
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      if ('VKIDSDK' in window) {
        const VKID = window.VKIDSDK;
        VKID.Config.init({
          app: 54268309,
          redirectUrl: window.location.origin + '/index.html',
          responseMode: VKID.ConfigResponseMode.Callback,
          source: VKID.ConfigSource.LOWCODE,
          scope: '',
        });

        const oneTap = new VKID.OneTap();
        oneTap.render({
          container: document.getElementById('vkOneTapContainer'),
          fastAuthEnabled: false,
          showAlternativeLogin: true
        })
        .on(VKID.WidgetEvents.ERROR, err => console.error('VK ID Error:', err))
        .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, async payload => {
          try {
            const vkId = payload.id || payload.user_id || payload.device_id;
            const username = await findUserByVK(vkId);

            if (username) {
              setUser(username);
            } else {
              alert('Ваш VK не найден в списке сотрудников.');
            }
          } catch (err) {
            console.error('Ошибка VK ID:', err);
            alert('Ошибка авторизации через VK.');
          }
        });
      } else {
        alert('VK ID SDK не загружен');
      }
    });
  </script>

</body>
</html>
