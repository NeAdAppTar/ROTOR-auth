<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>ROTOR — Авторизация</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="icon.png">
  <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js" defer></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #fdf6e3;
      flex-direction: column;
    }
    .auth-card {
      background: #fff8dc;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    .auth-card h1 {
      margin-bottom: 10px;
      color: #facc15;
      font-size: 2rem;
    }
    .auth-card p.subtitle {
      color: #111827;
      margin-bottom: 20px;
    }
    .logout-btn {
      margin-top: 20px;
      background: #facc15;
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: #eab308;
    }
  </style>
</head>
<body>

  <div class="auth-card">
    <h1>ROTOR</h1>
    <p class="subtitle">Вход через VK</p>
    <div id="vkOneTapContainer"></div>
    <button class="logout-btn" onclick="logout()">Выйти</button>
  </div>

  <script>
    function logout() {
      document.cookie = "userLogin=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
      localStorage.removeItem('userLogin');
      location.reload();
    }

    function setUser(username) {
      document.cookie = `userLogin=${username}; path=/; max-age=3600`;
      localStorage.setItem('userLogin', username);

      const redirect = new URLSearchParams(window.location.search).get('redirect') || 'employee_dashboard.html';
      window.location.href = redirect;
    }

    async function findUserByVK(vkId) {
      try {
        const res = await fetch('https://rotor.pythonanywhere.com/users');
        if (!res.ok) throw new Error('Ошибка загрузки пользователей');
        const data = await res.json();

        const vkUrl = `https://vk.com/id${vkId}`;
        const found = Object.values(data).find(u => u.vk && u.vk.includes(vkUrl));

        return found ? found.login : null;
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      if ('VKIDSDK' in window) {
        const VKID = window.VKIDSDK;
        VKID.Config.init({
          app: 54268309,
          redirectUrl: window.location.origin + '/index.html',
          responseMode: VKID.ConfigResponseMode.Callback,
          source: VKID.ConfigSource.LOWCODE,
          scope: '',
        });

        const oneTap = new VKID.OneTap();
        oneTap.render({
          container: document.getElementById('vkOneTapContainer'),
          fastAuthEnabled: false,
          showAlternativeLogin: true
        })
        .on(VKID.WidgetEvents.ERROR, err => console.error('VK ID Error:', err))
        .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, async payload => {
          try {
            const vkId = payload.id || payload.user_id || payload.device_id;
            const username = await findUserByVK(vkId);

            if (username) {
              setUser(username);
            } else {
              alert('Ваш VK не найден в списке сотрудников.');
            }
          } catch (err) {
            console.error('Ошибка VK ID:', err);
            alert('Ошибка авторизации через VK.');
          }
        });
      } else {
        alert('VK ID SDK не загружен');
      }
    });
  </script>

</body>
</html>
