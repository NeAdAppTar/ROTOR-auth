<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>ROTOR — Авторизация</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="stylesheet" href="style.css">

  <style>
    /* Полноэкранный фон */
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: url("pic1.jpg") no-repeat center center fixed;
      background-size: cover;
      font-family: "Segoe UI", sans-serif;
      color: white;
    }

    /* Карточка авторизации */
    .auth-card {
      background: rgba(0, 0, 0, 0.65);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      width: 340px;
    }

    .auth-card h1 {
      margin: 0 0 10px 0;
      font-size: 2em;
      letter-spacing: 1px;
    }

    .auth-card p {
      margin-bottom: 25px;
      color: #ccc;
    }

    /* Кнопка выхода (если нужно показывать после входа) */
    .logout-btn {
      margin-top: 15px;
      background: #ff5555;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
    }

    footer {
      font-size: 12px;
      color: #aaa;
      margin-top: 30px;
    }
  </style>
</head>

<body>
  <div class="auth-card">
    <h1>ROTOR</h1>
    <p>Вход через VK ID</p>

    <div id="vk_auth"></div>

    <footer>
      <p>ООО "Ротор", by NeAdAppTar, ShaUru1118</p>
    </footer>
  </div>

  <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>

  <script>
if ('VKIDSDK' in window) {
  const VKID = window.VKIDSDK;

  VKID.Config.init({
    app: 54268309,
    redirectUrl: 'https://auth.rotorbus.ru',
    responseMode: VKID.ConfigResponseMode.Callback,
    source: VKID.ConfigSource.LOWCODE,
    scope: '',
  });

  const oneTap = new VKID.OneTap();

  oneTap.render({
    container: document.getElementById("vk_auth"),
    fastAuthEnabled: false,
    showAlternativeLogin: true
  })
  .on(VKID.WidgetEvents.ERROR, vkidOnError)
  .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
    const code = payload.code;
    const deviceId = payload.device_id;

    VKID.Auth.exchangeCode(code, deviceId)
      .then(vkidOnSuccess)
      .catch(vkidOnError);
  });

 async function vkidOnSuccess(data) {
  try {
    console.log("Ответ VKID:", data);

    // Получаем VK ID
    const userId = data.user_id || data.user?.id;
    if (!userId) throw new Error("Не удалось получить VK ID пользователя.");

    // Ссылка на пользователя VK
    const vkUrl = `https://vk.com/id${userId}`;
    console.log("Авторизован VK:", vkUrl);

    // Загружаем всех сотрудников через GET
    const res = await fetch('https://rotor.pythonanywhere.com/user_info');
    if (!res.ok) throw new Error('Ошибка загрузки user_info');
    const text = await res.text();

    // Парсим строки как на employees.html
    const lines = text.split('\n');
    const found = lines.find(line => line.includes(vkUrl));

    if (found) {
      const username = found.split(' - ')[0].trim();

      // Сохраняем куки и локалсторедж
      document.cookie = `userLogin=${username}; path=/; max-age=3600`;
      localStorage.setItem('userLogin', username);

      alert(`Добро пожаловать, ${username}!`);
      
      // Редирект на страницу, с которой пришли, или дашборд
      const params = new URLSearchParams(window.location.search);
      const redirect = params.get('redirect') || '/employee_dashboard.html';
      window.location.href = redirect;

    } else {
      alert('Ваш VK не найден в списке сотрудников.');
    }
  } catch (err) {
    console.error('Ошибка VK ID:', err);
    alert('Ошибка при авторизации. Попробуйте позже.');
  }
}


  function vkidOnError(error) {
    console.error('VK ID Error:', error);
    alert('Ошибка входа через VK ID');
  }
}
</script>

</body>
</html>
