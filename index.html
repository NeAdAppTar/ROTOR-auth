<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>ROTOR ‚Äî –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
  <link rel="icon" href="icon.png" type="image/png">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #fff7cc, #fef3c7);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-card {
      background: white;
      padding: 40px 50px;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      text-align: center;
      width: 340px;
    }

    .auth-card h1 {
      font-size: 32px;
      color: #facc15;
      margin-bottom: 10px;
    }

    .auth-card p {
      color: #666;
      margin-bottom: 30px;
    }

    footer {
      margin-top: 30px;
      font-size: 12px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="auth-card">
    <h1>ROTOR</h1>
    <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ VK ID</p>

    <div id="vk_login"></div>

    <footer>
      <p>¬© –û–û–û ¬´–†–æ—Ç–æ—Ä¬ª | NeAdAppTar & ShaUru1118</p>
    </footer>
  </div>

  <script src="https://unpkg.com/@vkid/sdk@latest/dist-sdk/umd/index.js"></script>
  <script type="text/javascript">
    (function () {
      if (!('VKIDSDK' in window)) return;
      const VKID = window.VKIDSDK;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK ID
      VKID.Config.init({
        app: 54268309,
        redirectUrl: 'https://auth.rotorbus.ru',
        responseMode: VKID.ConfigResponseMode.Callback,
        source: VKID.ConfigSource.LOWCODE,
        scope: ''
      });

      const oneTap = new VKID.OneTap();

      oneTap.render({
        container: document.getElementById('vk_login'),
        fastAuthEnabled: false,
        showAlternativeLogin: true
      })
      .on(VKID.WidgetEvents.ERROR, vkidOnError)
      .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
        const code = payload.code;
        const deviceId = payload.device_id;

        VKID.Auth.exchangeCode(code, deviceId)
          .then(vkidOnSuccess)
          .catch(vkidOnError);
      });

      async function vkidOnSuccess(data) {
        console.log('VK ID response:', data);

        // data —Å–æ–¥–µ—Ä–∂–∏—Ç user_id –∏ access_token
        const vkId = data.user_id;

        // üîπ 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –µ—Å—Ç—å –ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å —ç—Ç–∏–º VK
        const res = await fetch('https://rotor.pythonanywhere.com/check_vk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vk_id: vkId })
        });

        const result = await res.json();

        if (result.status === 'ok') {
          // üîπ 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cookie userLogin –∏ userRole
          document.cookie = `userLogin=${encodeURIComponent(result.login)}; path=/; SameSite=Lax`;
          document.cookie = `userRole=${encodeURIComponent(result.role)}; path=/; SameSite=Lax`;

          // üîπ 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—É–¥–∞, –æ—Ç–∫—É–¥–∞ –æ–Ω –ø—Ä–∏—à—ë–ª
          const params = new URLSearchParams(window.location.search);
          const redirect = params.get('redirect') || 'https://rotorbus.ru/employee_dashboard.html';
          window.location.href = redirect;
        } else {
          alert('–í–∞—à VK –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é.');
        }
      }

      function vkidOnError(error) {
        console.error('–û—à–∏–±–∫–∞ VK ID:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ VK');
      }
    })();
  </script>
</body>
</html>
